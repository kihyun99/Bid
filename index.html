<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="나라장터 실시간 입찰공고 분석 대시보드 - 최신 조달 공고를 가장 스마트하게 확인하세요.">
    <title>BidDash | 나라장터 입찰공고 실시간 현황</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        slate: {
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            overflow-x: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .premium-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
        }

        .bg-blob {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }

        .blob-1 {
            background: radial-gradient(circle, #38bdf8 0%, transparent 70%);
            top: -200px;
            right: -100px;
            animation: float 20s infinite alternate;
        }

        .blob-2 {
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            bottom: -250px;
            left: -100px;
            animation: float 25s infinite alternate-reverse;
        }

        @keyframes float {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(50px, 50px) scale(1.1);
            }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .table-row-hover:hover {
            background-color: #f8fafc;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_BASE_URL = 'http://apis.data.go.kr/1230000/ao/PubDataOpnStdService/getDataSetOpnStdBidPblancInfo';

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const StatCard = ({ title, value, icon, color, textColor }) => (
            <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group border-white/40">
                <div className={`absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 opacity-5 ${color}`} />
                <div className="flex justify-between items-start mb-4">
                    <div className={`p-3 rounded-xl ${color} bg-opacity-10`}>
                        <Icon name={icon} size={24} className={textColor} />
                    </div>
                </div>
                <div className="flex flex-col">
                    <span className="text-slate-500 text-sm font-medium">{title}</span>
                    <span className="text-3xl font-bold mt-1 tracking-tight text-slate-900">{value}</span>
                </div>
            </div>
        );

        function App() {
            const [apiKey, setApiKey] = useState(localStorage.getItem('pps_api_key') || '692e2494ef42277ea5df6f9fb0eccabca3061d0fc6f417ca51b8ff166c14cc0e');
            const [startDate, setStartDate] = useState(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [bidList, setBidList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');
            const [error, setError] = useState(null);

            useEffect(() => {
                if (apiKey) {
                    localStorage.setItem('pps_api_key', apiKey);
                }
            }, [apiKey]);

            const fetchBids = async () => {
                if (!apiKey) {
                    setError('상단 설정에서 API 인증키(서비스키)를 입력해주세요.');
                    return;
                }

                setLoading(true);
                setError(null);
                setStatus('프록시 서버 연결 및 요청 준비 중...');

                try {
                    const bgnDt = startDate.replace(/-/g, '') + '0000';
                    const endDt = endDate.replace(/-/g, '') + '2359';

                    setStatus('나라장터(공공데이터포털) 서버에 데이터를 요청하고 있습니다...');
                    const targetUrl = `${API_BASE_URL}?ServiceKey=${apiKey}&type=json&bidNtceBgnDt=${bgnDt}&bidNtceEndDt=${endDt}&numOfRows=100&pageNo=1`;
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

                    const response = await axios.get(proxyUrl);
                    const responseData = response.data;

                    setStatus('서버 응답 데이터를 분석하는 중...');

                    // 1. Check for Forbidden or XML Error strings before JSON parsing
                    if (typeof responseData === 'string') {
                        if (responseData.includes('Forbidden')) {
                            throw new Error('API 서버 접근 거부 (Forbidden). API 키가 승인 대기 중이거나 활성화되지 않았습니다.');
                        }
                        if (responseData.includes('<returnAuthMsg>')) {
                            const msg = responseData.match(/<returnAuthMsg>(.*?)<\/returnAuthMsg>/)?.[1] || '인증 오류';
                            throw new Error(`API 인증 에러: ${msg}`);
                        }
                    }

                    // 2. Parse JSON
                    let dataObj;
                    try {
                        dataObj = typeof responseData === 'string' ? JSON.parse(responseData) : responseData;
                    } catch (e) {
                        console.error('JSON Parse Error:', responseData);
                        throw new Error('데이터 형식이 올바르지 않습니다 (JSON 파싱 실패). API 서버 일시적 장애일 수 있습니다.');
                    }

                    const data = dataObj.response;

                    if (data?.header?.resultCode !== '00') {
                        setError(`[API 에러] ${data?.header?.resultMsg || '알 수 없는 오류가 발생했습니다.'}`);
                        setBidList([]);
                    } else {
                        let items = data?.body?.items || [];
                        // 공공데이터 API 특성상 1건일 경우 배열이 아닌 객체로 올 수 있음
                        if (items && !Array.isArray(items)) {
                            items = [items];
                        }
                        setBidList(items);
                        if (items.length === 0) {
                            setError('해당 기간에 조회된 데이터가 없습니다. 조회 기간을 더 길게 설정해 보세요.');
                        } else {
                            setStatus(''); // 성공 시 상태 클리어
                        }
                    }
                } catch (err) {
                    console.error('Fetch Error:', err);
                    setError(err.message || '데이터를 가져오는데 실패했습니다.');
                } finally {
                    setLoading(false);
                }
            };

            const stats = useMemo(() => {
                const safeList = Array.isArray(bidList) ? bidList : [];
                const total = safeList.length;
                const urgent = safeList.filter(b => b && b.bidNtceNm && b.bidNtceNm.includes('긴급')).length;
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const closingToday = safeList.filter(b => b && b.bidClseDate === today).length;

                return [
                    { title: '전체 공고', value: total, icon: 'file-text', color: 'bg-sky-500', textColor: 'text-sky-600' },
                    { title: '긴급 공고', value: urgent, icon: 'alert-circle', color: 'bg-amber-500', textColor: 'text-amber-600' },
                    { title: '오늘 마감', value: closingToday, icon: 'clock', color: 'bg-rose-500', textColor: 'text-rose-600' },
                ];
            }, [bidList]);

            return (
                <div className="min-h-screen relative p-4 md:p-8">
                    <div className="bg-blob blob-1" />
                    <div className="bg-blob blob-2" />

                    <div className="max-w-7xl mx-auto">
                        <header className="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900">
                                    나라장터 실시간 대시보드
                                </h1>
                                <p className="text-slate-500 mt-1 font-medium">PPS Real-time Bid Monitor</p>
                            </div>

                            <div className="glass-panel p-4 rounded-2xl flex flex-wrap gap-4 items-end">
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">인증키 (서비스키)</label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="API KEY"
                                        className="bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20 outline-none w-48 text-slate-900 transition-all font-mono"
                                    />
                                </div>
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">조회 기간</label>
                                    <div className="flex items-center bg-white border border-slate-200 rounded-xl px-2 focus-within:border-sky-500 focus-within:ring-2 focus-within:ring-sky-500/20 transition-all">
                                        <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent p-2 text-xs outline-none text-slate-900 font-medium" />
                                        <span className="text-slate-300">~</span>
                                        <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent p-2 text-xs outline-none text-slate-900 font-medium" />
                                    </div>
                                </div>
                                <button
                                    onClick={fetchBids}
                                    disabled={loading}
                                    className="px-6 py-2.5 premium-gradient rounded-xl font-bold flex items-center gap-2 hover:opacity-90 transition-all disabled:opacity-50 h-[42px]"
                                >
                                    {loading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="search" />}
                                    검색
                                </button>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            {stats.map((stat, i) => <StatCard key={i} {...stat} />)}
                        </div>

                        <div className="glass-panel rounded-3xl overflow-hidden flex flex-col min-h-[500px] border-white/60 shadow-xl shadow-slate-200/50">
                            <div className="p-6 border-b border-slate-100 bg-white/50 flex items-center justify-between">
                                <h3 className="font-bold flex items-center gap-2 text-slate-800">
                                    <Icon name="list" className="text-sky-500" />
                                    입찰 공고 현황
                                </h3>
                                <span className="text-xs text-sky-600 bg-sky-50 px-3 py-1 rounded-full border border-sky-100 font-bold uppercase tracking-wider">
                                    {bidList.length}건 데이터
                                </span>
                            </div>

                            {error ? (
                                <div className="flex-1 flex flex-col items-center justify-center p-12 text-center bg-white/50">
                                    <div className="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mb-4">
                                        <Icon name="alert-triangle" size={32} className="text-rose-500" />
                                    </div>
                                    <p className="text-slate-800 font-bold mb-2">조회에 실패했습니다</p>
                                    <p className="text-slate-500 max-w-sm text-sm leading-relaxed">{error}</p>
                                </div>
                            ) : loading ? (
                                <div className="flex-1 flex flex-col items-center justify-center p-20 text-center bg-white/50">
                                    <div className="relative mb-6">
                                        <div className="w-16 h-16 border-4 border-sky-100 border-t-sky-500 rounded-full animate-spin"></div>
                                        <div className="absolute inset-0 flex items-center justify-center">
                                            <Icon name="search" size={24} className="text-sky-500 animate-pulse" />
                                        </div>
                                    </div>
                                    <p className="text-slate-800 font-bold mb-2">데이터를 불러오는 중입니다</p>
                                    <p className="text-sky-600 text-sm font-medium animate-pulse">{status}</p>
                                </div>
                            ) : bidList.length > 0 ? (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm border-collapse">
                                        <thead className="bg-slate-50/80 text-slate-500 uppercase tracking-wider">
                                            <tr>
                                                <th className="px-6 py-4 font-bold text-[11px]">정보</th>
                                                <th className="px-6 py-4 font-bold text-[11px] w-1/2">입찰공고명</th>
                                                <th className="px-6 py-4 font-bold text-[11px]">공고기관</th>
                                                <th className="px-6 py-4 font-bold text-[11px] text-right">마감일시</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 bg-white">
                                            {bidList.map((bid, i) => {
                                                const isUrgent = bid.bidNtceNm.includes('긴급');
                                                const isToday = bid.bidClseDate === new Date().toISOString().split('T')[0].replace(/-/g, '');
                                                return (
                                                    <tr key={i} className="hover:bg-slate-50/50 transition-colors group">
                                                        <td className="px-6 py-5">
                                                            <div className="flex flex-col">
                                                                <span className="text-[10px] text-sky-600 font-bold uppercase tracking-tight">{bid.bsnsDivNm}</span>
                                                                <span className="text-slate-400 font-mono text-xs mt-0.5">{bid.bidNtceNo}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <div className="flex flex-col gap-2">
                                                                <div className="flex gap-2">
                                                                    {isUrgent && <span className="px-2 py-0.5 rounded text-[10px] bg-amber-50 text-amber-600 border border-amber-200 font-bold">긴급</span>}
                                                                    {isToday && <span className="px-2 py-0.5 rounded text-[10px] bg-rose-50 text-rose-600 border border-rose-200 font-bold animate-pulse">오늘마감</span>}
                                                                </div>
                                                                <a href={bid.bidNtceUrl} target="_blank" className="text-slate-800 font-semibold group-hover:text-sky-600 transition-colors leading-snug line-clamp-2">
                                                                    {bid.bidNtceNm}
                                                                </a>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <div className="flex items-center gap-2 text-slate-600">
                                                                <div className="p-1.5 rounded-lg bg-slate-100">
                                                                    <Icon name="building-2" size={12} className="text-slate-400" />
                                                                </div>
                                                                <span className="font-medium text-xs">{bid.ntceInsttNm}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5 text-right">
                                                            <div className={`flex flex-col ${isToday ? 'text-rose-600' : 'text-slate-600'}`}>
                                                                <span className="font-bold text-sm tracking-tight">{bid.bidClseDate?.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')}</span>
                                                                <span className="text-[11px] font-medium opacity-60 mt-0.5">{bid.bidClseTm?.replace(/(\d{2})(\d{2})/, '$1:$2')}</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center p-20 text-center opacity-30">
                                    <Icon name="search" size={64} className="mb-4 text-slate-300" />
                                    <p className="font-bold text-slate-500">대기 중</p>
                                    <p className="text-sm mt-2 text-slate-400">상위 검색 조건을 설정하고 검색 버튼을 눌러주세요.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>