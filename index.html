<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="나라장터 실시간 입찰공고 분석 대시보드">
    <title>BidDash | 나라장터 입찰공고</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js" crossorigin></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js" crossorigin></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        :root {
            --pps-blue: #005eb8;
            --pps-dark: #1e293b;
            --pps-light: #f8fafc;
            --pps-border: #e2e8f0;
        }

        body {
            font-family: 'Noto+Sans+KR', 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--pps-dark);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--pps-border);
        }

        .search-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--pps-border);
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--pps-border);
            overflow: hidden;
        }

        .btn-pps {
            background-color: var(--pps-blue);
            color: white;
            transition: all 0.2s;
        }

        .btn-pps:hover {
            background-color: #004a91;
            transform: translateY(-1px);
        }

        .tab-active {
            border-bottom: 3px solid var(--pps-blue);
            color: var(--pps-blue);
            font-weight: 700;
        }

        .filter-label {
            width: 100px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            display: flex;
            align-items: center;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8125rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .checkbox-group label:hover {
            background: #f1f5f9;
        }

        .input-base {
            border: 1px solid var(--pps-border);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-base:focus {
            border-color: var(--pps-blue);
        }

        th {
            background-color: #f8fafc;
            font-size: 0.75rem;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            padding: 12px 16px;
            border-bottom: 2px solid var(--pps-border);
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            font-size: 0.8125rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .tag-gray {
            background: #f1f5f9;
            color: #475569;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // 전역 에러 핸들러
        window.onerror = function (msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h2 style="color: #e11d48;">시스템 오류가 발생했습니다</h2>
                        <p>${msg}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #005eb8; color: white; border-radius: 6px;">새로고침</button>
                    </div>`;
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_BASE_URL = 'https://apis.data.go.kr/1230000/ao/PubDataOpnStdService/getDataSetOpnStdBidPblancInfo';
        const FIXED_API_KEY = '692e2494ef42277ea5df6f9fb0eccabca3061d0fc6f417ca51b8ff166c14cc0e';

        const Icon = ({ name, size = 16, className = "" }) => {
            const elRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && elRef.current) {
                    elRef.current.innerHTML = '';
                    const icon = window.lucide.createIcons({
                        icons: { [name]: window.lucide.icons[name] },
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <span ref={elRef} className="inline-flex items-center"></span>;
        };

        function App() {
            // State
            const [startDate, setStartDate] = useState(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [keyword, setKeyword] = useState('');
            const [bidNo, setBidNo] = useState('');
            const [selectedDivs, setSelectedDivs] = useState(['전체']);

            const [bidList, setBidList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentPage, setCurrentPage] = useState(1);
            const [error, setError] = useState(null);

            const businessDivs = ['전체', '물품', '일반용역', '기술용역', '공사', '기타', '민간'];

            const setDateRange = (months) => {
                const end = new Date();
                const start = new Date();
                start.setMonth(end.getMonth() - months);
                setStartDate(start.toISOString().split('T')[0]);
                setEndDate(end.toISOString().split('T')[0]);
            };

            const toggleDiv = (div) => {
                if (div === '전체') {
                    setSelectedDivs(['전체']);
                } else {
                    let next = selectedDivs.filter(d => d !== '전체');
                    if (next.includes(div)) {
                        next = next.filter(d => d !== div);
                        if (next.length === 0) next = ['전체'];
                    } else {
                        next.push(div);
                    }
                    setSelectedDivs(next);
                }
            };

            const fetchBids = async () => {
                setLoading(true);
                setError(null);
                setCurrentPage(1);

                try {
                    const bgnDt = startDate.replace(/-/g, '') + '0000';
                    const endDt = endDate.replace(/-/g, '') + '2359';

                    const targetUrl = `${API_BASE_URL}?ServiceKey=${FIXED_API_KEY}&type=json&bidNtceBgnDt=${bgnDt}&bidNtceEndDt=${endDt}&numOfRows=500&pageNo=1`;
                    // allorigins proxy 사용 (캐시 방지를 위해 timestamp 추가)
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&_=${Date.now()}`;

                    const response = await axios.get(proxyUrl);

                    if (!response.data || !response.data.contents) {
                        throw new Error('프록시 서버로부터 응답을 받지 못했습니다.');
                    }

                    let responseData = response.data.contents;
                    try {
                        if (typeof responseData === 'string') {
                            responseData = JSON.parse(responseData);
                        }
                    } catch (e) {
                        console.error('JSON 파싱 에러:', responseData);
                        if (responseData.includes('SERVICE_KEY_IS_NOT_REGISTERED_ERROR')) {
                            throw new Error('인증키가 등록되지 않았거나 유효하지 않습니다.');
                        }
                        throw new Error('서버 데이터를 해석할 수 없습니다. (형식 오류)');
                    }

                    const data = responseData?.response;

                    if (!data) {
                        throw new Error('잘못된 데이터 구조가 반환되었습니다.');
                    }

                    if (data?.header?.resultCode !== '00') {
                        throw new Error(data?.header?.resultMsg || 'API 통신 오류');
                    }

                    let items = data?.body?.items || [];
                    if (!Array.isArray(items)) items = [items];

                    // Filtering
                    let filtered = items;

                    // Business Division Filter
                    if (!selectedDivs.includes('전체')) {
                        filtered = filtered.filter(item => selectedDivs.includes(item.bsnsDivNm));
                    }

                    // Keyword Filter
                    if (keyword.trim()) {
                        filtered = filtered.filter(item => item.bidNtceNm?.includes(keyword.trim()));
                    }

                    // Bid No Filter
                    if (bidNo.trim()) {
                        filtered = filtered.filter(item => item.bidNtceNo?.includes(bidNo.trim()));
                    }

                    setBidList(filtered);
                    if (filtered.length === 0) setError('조회된 데이터가 없습니다.');
                } catch (err) {
                    let msg = err.message || '알 수 없는 오류가 발생했습니다.';
                    if (msg.includes('403')) {
                        msg = '접근 권한이 거부되었습니다(403). 인증키가 올바른지, 혹은 현재 국가번호/환경에서 접근이 가능한지 확인해주세요.';
                    }
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            const displayList = useMemo(() => {
                const start = (currentPage - 1) * 10;
                return bidList.slice(start, start + 10);
            }, [bidList, currentPage]);

            return (
                <div className="min-h-screen pb-12">
                    {/* Header Tabs */}
                    <div className="glass-header sticky top-0 z-50">
                        <div className="max-w-[1400px] mx-auto px-6 h-14 flex items-center">
                            <div className="flex gap-8 h-full">
                                <button className="tab-active px-2 h-full flex items-center gap-2">
                                    입찰공고
                                    <span className="text-[10px] bg-sky-100 text-sky-600 px-1.5 py-0.5 rounded-full font-bold">STABLE 2.1</span>
                                </button>
                                <button className="text-slate-500 hover:text-slate-800 px-2 h-full flex items-center transition-colors">개찰결과</button>
                                <button className="text-slate-500 hover:text-slate-800 px-2 h-full flex items-center transition-colors">최종낙찰자</button>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-[1400px] mx-auto px-6 mt-6">
                        {/* Search Section */}
                        <section className="search-container p-6 mb-8">
                            <div className="grid grid-cols-1 gap-4">
                                {/* Type Row */}
                                <div className="flex items-center gap-4 py-1">
                                    <span className="filter-label">검색유형</span>
                                    <div className="flex gap-2">
                                        <button className="px-4 py-1.5 rounded bg-sky-50 text-sky-700 border border-sky-200 text-xs font-bold">입찰공고</button>
                                        <button className="px-4 py-1.5 rounded bg-white text-slate-500 border border-slate-200 text-xs">개찰결과</button>
                                        <button className="px-4 py-1.5 rounded bg-white text-slate-500 border border-slate-200 text-xs">최종낙찰자</button>
                                    </div>

                                    <span className="filter-label ml-12">입찰공고번호</span>
                                    <input
                                        type="text"
                                        className="input-base w-48"
                                        value={bidNo}
                                        onChange={(e) => setBidNo(e.target.value)}
                                        placeholder="공고번호를 입력하세요"
                                    />
                                </div>

                                {/* Date Row */}
                                <div className="flex items-center gap-4 py-1">
                                    <span className="filter-label">공고게시일자</span>
                                    <div className="flex items-center gap-2">
                                        <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="input-base text-xs" />
                                        <span className="text-slate-400">~</span>
                                        <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="input-base text-xs" />
                                    </div>
                                    <div className="flex gap-1 ml-4">
                                        {[1, 3, 6].map(m => (
                                            <button
                                                key={m}
                                                onClick={() => setDateRange(m)}
                                                className="px-3 py-1.5 rounded bg-slate-100 text-slate-600 border border-slate-200 text-[11px] font-bold hover:bg-slate-200"
                                            >
                                                최근 {m}개월
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Division Row */}
                                <div className="flex items-start gap-4 py-1">
                                    <span className="filter-label pt-1">업무구분</span>
                                    <div className="flex flex-wrap gap-2 checkbox-group">
                                        {businessDivs.map(div => (
                                            <label key={div} className={selectedDivs.includes(div) ? 'text-sky-600 font-bold bg-sky-50' : ''}>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDivs.includes(div)}
                                                    onChange={() => toggleDiv(div)}
                                                    className="w-3.5 h-3.5 accent-sky-600"
                                                />
                                                {div}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Title Row */}
                                <div className="flex items-center gap-4 py-1">
                                    <span className="filter-label">공고명</span>
                                    <div className="flex flex-1 gap-4 items-center">
                                        <input
                                            type="text"
                                            className="input-base flex-1"
                                            value={keyword}
                                            onChange={(e) => setKeyword(e.target.value)}
                                            placeholder="검색할 공고명을 입력하세요"
                                            onKeyPress={(e) => e.key === 'Enter' && fetchBids()}
                                        />
                                        <div className="flex gap-2">
                                            <button onClick={() => { setKeyword(''); setBidNo(''); setSelectedDivs(['전체']); }} className="px-6 py-2 rounded border border-slate-300 bg-white text-slate-600 text-sm font-semibold hover:bg-slate-50 flex items-center gap-2">
                                                <Icon name="rotate-ccw" /> 초기화
                                            </button>
                                            <button onClick={fetchBids} disabled={loading} className="px-10 py-2 rounded btn-pps text-sm font-bold flex items-center gap-2 shadow-lg shadow-sky-500/20">
                                                {loading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="search" />} 검색
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* List Section */}
                        <div className="mb-4 flex justify-between items-end">
                            <h2 className="text-lg font-bold flex items-center gap-2">
                                <span className="w-1 h-5 bg-sky-600 rounded-full"></span>
                                입찰공고목록
                                <span className="text-slate-400 text-sm font-normal ml-2">전체 {bidList.length}건</span>
                            </h2>
                            <div className="flex gap-2">
                                <button className="px-3 py-1.5 rounded border border-emerald-300 bg-emerald-50 text-emerald-700 text-xs font-bold flex items-center gap-2 hover:bg-emerald-100 transition-colors">
                                    <Icon name="file-spread-sheet" size={14} /> 엑셀다운로드
                                </button>
                                <select className="input-base text-xs py-1">
                                    <option>10개씩 보기</option>
                                    <option>30개씩 보기</option>
                                    <option>50개씩 보기</option>
                                </select>
                            </div>
                        </div>

                        <section className="table-container">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse min-w-[1200px]">
                                    <thead>
                                        <tr>
                                            <th className="w-16 text-center">No</th>
                                            <th className="w-24">업무</th>
                                            <th className="w-40">입찰공고번호</th>
                                            <th>공고명</th>
                                            <th className="w-48">공고기관</th>
                                            <th className="w-48">수요기관</th>
                                            <th className="w-40 text-right">게시일시</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white">
                                        {loading ? (
                                            <tr>
                                                <td colSpan="7" className="py-20 text-center">
                                                    <div className="flex flex-col items-center gap-4">
                                                        <div className="w-10 h-10 border-4 border-sky-100 border-t-sky-500 rounded-full animate-spin"></div>
                                                        <p className="text-slate-500 text-sm font-medium">데이터를 분석하고 있습니다...</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        ) : bidList.length > 0 ? (
                                            displayList.map((bid, i) => (
                                                <tr key={bid.bidNtceNo + i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="text-center text-slate-400 font-mono">{(currentPage - 1) * 10 + i + 1}</td>
                                                    <td>
                                                        <span className="tag-gray">{bid.bsnsDivNm || '알수없음'}</span>
                                                    </td>
                                                    <td className="font-mono text-slate-500">{bid.bidNtceNo}</td>
                                                    <td>
                                                        <div className="flex flex-col gap-1">
                                                            <a href={bid.bidNtceUrl} target="_blank" className="text-slate-900 font-semibold hover:text-sky-600 line-clamp-1">
                                                                {bid.bidNtceNm}
                                                            </a>
                                                            <div className="flex gap-2">
                                                                {bid.bidNtceNm?.includes('긴급') && <span className="text-[10px] px-1 bg-red-50 text-red-500 border border-red-100 font-bold">긴급</span>}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="text-slate-600">{bid.ntceInsttNm}</td>
                                                    <td className="text-slate-600">{bid.dminsttNm || bid.ntceInsttNm}</td>
                                                    <td className="text-right">
                                                        <div className="flex flex-col">
                                                            <span className="font-bold text-slate-700">{(bid.bidNtceDt || bid.bidNtceDtTm || '').replace(/(\d{4})(\d{2})(\d{2}).*/, '$1-$2-$3')}</span>
                                                            <span className="text-[10px] text-slate-400">{(bid.bidNtceDt || bid.bidNtceDtTm || '').replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2}).*/, '$4:$5')}</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="7" className="py-20 text-center">
                                                    <div className="flex flex-col items-center gap-2 opacity-30">
                                                        <Icon name="search" size={48} className="text-slate-400" />
                                                        <p className="text-lg font-bold text-slate-500">{error || '검색 결과가 없습니다'}</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>

                            {/* Pagination */}
                            {bidList.length > 10 && (
                                <div className="p-6 border-t border-slate-100 flex justify-center gap-1">
                                    <button onClick={() => setCurrentPage(1)} className="p-2 border border-slate-200 rounded hover:bg-slate-50"><Icon name="chevrons-left" size={14} /></button>
                                    <button onClick={() => setCurrentPage(Math.max(1, currentPage - 1))} className="p-2 border border-slate-200 rounded hover:bg-slate-50"><Icon name="chevron-left" size={14} /></button>

                                    {Array.from({ length: Math.min(10, Math.ceil(bidList.length / 10)) }, (_, i) => {
                                        const pageNum = i + 1;
                                        return (
                                            <button
                                                key={pageNum}
                                                onClick={() => setCurrentPage(pageNum)}
                                                className={`w-10 h-10 rounded border font-bold text-xs transition-all ${currentPage === pageNum ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-slate-500 border-slate-200 hover:border-sky-300 hover:text-sky-600'}`}
                                            >
                                                {pageNum}
                                            </button>
                                        );
                                    })}

                                    <button onClick={() => setCurrentPage(Math.min(Math.ceil(bidList.length / 10), currentPage + 1))} className="p-2 border border-slate-200 rounded hover:bg-slate-50"><Icon name="chevron-right" size={14} /></button>
                                    <button onClick={() => setCurrentPage(Math.ceil(bidList.length / 10))} className="p-2 border border-slate-200 rounded hover:bg-slate-50"><Icon name="chevrons-right" size={14} /></button>
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>