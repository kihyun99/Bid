<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="나라장터 실시간 입찰공고 분석 대시보드 - 최신 조달 공고를 가장 스마트하게 확인하세요.">
    <title>BidDash | 나라장터 입찰공고 실시간 현황</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.474.0/dist/lucide.min.js" crossorigin></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" crossorigin></script>
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        slate: {
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .premium-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
        }

        .bg-blob {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }

        .blob-1 {
            background: radial-gradient(circle, #38bdf8 0%, transparent 70%);
            top: -200px;
            right: -100px;
            animation: float 20s infinite alternate;
        }

        .blob-2 {
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            bottom: -250px;
            left: -100px;
            animation: float 25s infinite alternate-reverse;
        }

        @keyframes float {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(50px, 50px) scale(1.1);
            }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // 전역 에러 핸들러: 화이트 스크린 방지 및 상세 정보 획득 시도
        window.onerror = function (msg, url, line, col, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 30px; color: #e11d48; background: white; border: 2px solid #fda4af; margin: 40px auto; max-width: 600px; border-radius: 20px; font-family: sans-serif; shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                        <h2 style="margin-top: 0; color: #be123c;">시스템 로드 중 오류가 발생했습니다</h2>
                        <p style="color: #475569; font-size: 14px;">브라우저 보안 설정이나 네트워크 문제로 라이브러리를 불러오지 못했을 수 있습니다.</p>
                        <div style="background: #fff1f2; padding: 15px; border-radius: 10px; margin: 20px 0; font-family: monospace; font-size: 13px;">
                            <strong>Error:</strong> ${msg}<br>
                            <strong>Info:</strong> ${line}행 ${col}열
                        </div>
                        <button onclick="location.reload()" style="background: #e11d48; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%;">새로고침하여 다시 시도</button>
                    </div>
                `;
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const API_BASE_URL = 'https://apis.data.go.kr/1230000/ao/PubDataOpnStdService/getDataSetOpnStdBidPblancInfo';

        // React 안전한 아이콘 컴포넌트 (DOM 변형 방지)
        const Icon = ({ name, size = 20, className = "" }) => {
            const elRef = useRef(null);
            useEffect(() => {
                if (window.lucide && elRef.current) {
                    elRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        elements: [elRef.current.firstChild]
                    });
                    const svg = elRef.current.firstChild;
                    if (svg && svg.tagName === 'svg') {
                        svg.setAttribute('class', className);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        svg.style.display = 'block';
                    }
                }
            }, [name, size, className]);
            return <span ref={elRef} className="inline-flex items-center justify-center pointer-events-none"></span>;
        };

        const StatCard = ({ title, value, icon, color, textColor }) => (
            <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group border-white/40">
                <div className={`absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 opacity-5 ${color}`} />
                <div className="flex justify-between items-start mb-4">
                    <div className={`p-3 rounded-xl ${color} bg-opacity-10`}>
                        <Icon name={icon} size={24} className={textColor} />
                    </div>
                </div>
                <div className="flex flex-col">
                    <span className="text-slate-500 text-sm font-medium">{title}</span>
                    <span className="text-3xl font-bold mt-1 tracking-tight text-slate-900">{value}</span>
                </div>
            </div>
        );

        function App() {
            // 인증키를 소스코드 내에 고정 (보안상 화면에는 노출되지 않음)
            const apiKey = '692e2494ef42277ea5df6f9fb0eccabca3061d0fc6f417ca51b8ff166c14cc0e';

            const [startDate, setStartDate] = useState(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [keyword, setKeyword] = useState(''); // 키워드 검색 상태 추가
            const [currentPage, setCurrentPage] = useState(1); // 현재 페이지 상태 추가
            const [bidList, setBidList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('');
            const [error, setError] = useState(null);

            const fetchBids = async () => {
                if (!apiKey) {
                    setError('상단 설정에서 공공데이터포털 API 인증키를 입력해주세요.');
                    return;
                }

                setLoading(true);
                setError(null);
                setCurrentPage(1); // 검색 시 페이지 초기화
                setStatus('인증키 확인 및 프록시 연결 준비 중...');

                try {
                    const bgnDt = startDate.replace(/-/g, '') + '0000';
                    const endDt = endDate.replace(/-/g, '') + '2359';
                    setStatus('공공데이터 포털 서버에 데이터를 요청하고 있습니다...');

                    const targetUrl = `${API_BASE_URL}?ServiceKey=${encodeURIComponent(apiKey)}&type=json&bidNtceBgnDt=${bgnDt}&bidNtceEndDt=${endDt}&numOfRows=100&pageNo=1`;
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

                    const response = await axios.get(proxyUrl).catch(err => {
                        if (err.response) return err.response;
                        throw err;
                    });

                    const responseData = response.data;
                    setStatus('서버 응답 데이터를 분석하는 중...');

                    if (typeof responseData === 'string') {
                        if (responseData.includes('Forbidden') || responseData.includes('invalid')) {
                            throw new Error('인증키가 올바르지 않거나 승인 대기 상태입니다.');
                        }
                    }

                    let dataObj = responseData;
                    if (typeof responseData === 'string' && responseData.trim().startsWith('{')) {
                        dataObj = JSON.parse(responseData);
                    }

                    const data = dataObj.response;
                    if (data?.header?.resultCode !== '00') {
                        setError(`[API 에러] ${data?.header?.resultMsg || '공공데이터 포털 통신 실패'}`);
                        setBidList([]);
                    } else {
                        let items = data?.body?.items || [];
                        if (items && !Array.isArray(items)) items = [items];

                        // 키워드가 있을 경우 공고명 필터링
                        let resultItems = items;
                        if (keyword.trim()) {
                            resultItems = items.filter(item =>
                                item.bidNtceNm && item.bidNtceNm.includes(keyword.trim())
                            );
                        }

                        setBidList(resultItems);
                        if (resultItems.length === 0) {
                            setError('해당 조건에 일치하는 공고가 없습니다.');
                        } else {
                            setStatus('');
                        }
                    }
                } catch (err) {
                    setError(err.message || '데이터를 가져오는 중 오류가 발생했습니다.');
                } finally {
                    setLoading(false);
                }
            };



            return (
                <div className="min-h-screen relative p-4 md:p-8">
                    <div className="bg-blob blob-1" />
                    <div className="bg-blob blob-2" />

                    <div className="max-w-7xl mx-auto">
                        <header className="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900 tracking-tight">나라장터 실시간 대시보드</h1>
                                <p className="text-slate-500 mt-1 font-medium flex items-center gap-2">
                                    PPS Real-time Bid Monitor
                                    <span className="text-[10px] bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full font-bold">STABLE 2.0</span>
                                </p>
                            </div>

                            <div className="glass-panel p-4 rounded-2xl flex flex-wrap gap-4 items-end shadow-lg shadow-slate-200/50">
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">조회 기간</label>
                                    <div className="flex items-center bg-white border border-slate-200 rounded-xl px-2 focus-within:border-sky-500 focus-within:ring-2 focus-within:ring-sky-500/20 transition-all">
                                        <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="bg-transparent p-2 text-xs outline-none text-slate-900 font-medium" />
                                        <span className="text-slate-300">~</span>
                                        <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="bg-transparent p-2 text-xs outline-none text-slate-900 font-medium" />
                                    </div>
                                </div>
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">키워드 (선택)</label>
                                    <div className="flex items-center bg-white border border-slate-200 rounded-xl px-2 focus-within:border-sky-500 focus-within:ring-2 focus-within:ring-sky-500/20 transition-all">
                                        <input
                                            type="text"
                                            value={keyword}
                                            onChange={(e) => setKeyword(e.target.value)}
                                            placeholder="공고명 검색어"
                                            className="bg-transparent p-2 text-xs outline-none text-slate-900 font-medium w-32"
                                            onKeyPress={(e) => e.key === 'Enter' && fetchBids()}
                                        />
                                    </div>
                                </div>
                                <button
                                    onClick={fetchBids}
                                    disabled={loading}
                                    className="px-6 py-2.5 premium-gradient text-white rounded-xl font-bold flex items-center gap-2 hover:shadow-lg hover:shadow-sky-500/30 transition-all disabled:opacity-50 h-[42px]"
                                >
                                    {loading ? <Icon name="loader-2" size={20} className="animate-spin" /> : <Icon name="search" size={20} />}
                                    검색하기
                                </button>
                            </div>
                        </header>



                        <div className="glass-panel rounded-3xl overflow-hidden flex flex-col min-h-[500px] border-white/60 shadow-xl shadow-slate-200/50">
                            <div className="p-6 border-b border-slate-100 bg-white/50 flex items-center justify-between">
                                <h3 className="font-bold flex items-center gap-2 text-slate-800">
                                    <Icon name="list" className="text-sky-500" />
                                    공고 목록
                                </h3>
                                <span className="text-xs text-sky-600 bg-sky-50 px-3 py-1 rounded-full border border-sky-100 font-bold">
                                    {bidList.length}건
                                </span>
                            </div>

                            {error ? (
                                <div className="flex-1 flex flex-col items-center justify-center p-12 text-center bg-white/50">
                                    <Icon name="alert-circle" size={48} className="text-rose-500 mb-4 opacity-50" />
                                    <p className="text-slate-800 font-bold mb-2">데이터 조회가 중단되었습니다</p>
                                    <p className="text-slate-500 max-w-sm text-sm">{error}</p>
                                </div>
                            ) : loading ? (
                                <div className="flex-1 flex flex-col items-center justify-center p-20 text-center bg-white/50">
                                    <div className="relative mb-8">
                                        <div className="w-16 h-16 border-4 border-sky-100 border-t-sky-500 rounded-full animate-spin"></div>
                                        <div className="absolute inset-0 flex items-center justify-center">
                                            <Icon name="database" size={20} className="text-sky-500 animate-pulse" />
                                        </div>
                                    </div>
                                    <p className="text-sky-600 text-sm font-medium animate-pulse">{status}</p>
                                </div>
                            ) : bidList.length > 0 ? (
                                <div className="flex-1 flex flex-col">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm border-collapse">
                                            <thead className="bg-slate-50 text-slate-500 uppercase tracking-wider">
                                                <tr>
                                                    <th className="px-6 py-4 font-bold text-[11px]">정보</th>
                                                    <th className="px-6 py-4 font-bold text-[11px] w-1/2">입찰공고명</th>
                                                    <th className="px-6 py-4 font-bold text-[11px]">기관</th>
                                                    <th className="px-6 py-4 font-bold text-[11px] text-right">공고일자</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 bg-white">
                                                {bidList.slice((currentPage - 1) * 10, currentPage * 10).map((bid, i) => (
                                                    <tr key={bid?.bidNtceNo || i} className="hover:bg-slate-50/50 transition-colors group">
                                                        <td className="px-6 py-5">
                                                            <div className="flex flex-col">
                                                                <span className="text-[10px] text-sky-600 font-bold">{bid.bsnsDivNm}</span>
                                                                <span className="text-slate-400 font-mono text-xs">{bid.bidNtceNo}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <div className="flex flex-col gap-1">
                                                                <div className="flex gap-1">
                                                                    {bid?.bidNtceNm?.includes('긴급') && <span className="px-1.5 py-0.5 rounded text-[9px] bg-amber-50 text-amber-600 border border-amber-200 font-bold">긴급</span>}
                                                                </div>
                                                                <a href={bid.bidNtceUrl} target="_blank" className="text-slate-800 font-semibold group-hover:text-sky-600 transition-colors line-clamp-2">
                                                                    {bid.bidNtceNm}
                                                                </a>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <span className="text-slate-600 text-xs">{bid.ntceInsttNm}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-right whitespace-nowrap">
                                                            <div className="flex flex-col text-slate-600">
                                                                <span className="font-bold text-xs">{(bid.bidNtceDt || bid.bidNtceDtTm || '').replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2}).*/, '$1-$2-$3')}</span>
                                                                <span className="text-[10px] opacity-60 font-medium">{(bid.bidNtceDt || bid.bidNtceDtTm || '').replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2}).*/, '$4:$5')}</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* 페이지네이션 UI */}
                                    <div className="p-6 bg-slate-50/50 border-t border-slate-100 flex justify-center items-center gap-2 mt-auto">
                                        {Array.from({ length: Math.ceil(bidList.length / 10) }, (_, i) => i + 1).map(page => (
                                            <button
                                                key={page}
                                                onClick={() => setCurrentPage(page)}
                                                className={`w-8 h-8 rounded-lg text-xs font-bold transition-all ${currentPage === page
                                                    ? 'bg-sky-500 text-white shadow-md shadow-sky-500/20 scale-110'
                                                    : 'bg-white text-slate-400 hover:text-sky-500 border border-slate-200'
                                                    }`}
                                            >
                                                {page}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center p-20 text-center opacity-30">
                                    <Icon name="search" size={64} className="mb-4 text-slate-300" />
                                    <p className="font-bold text-slate-500">조회된 공고가 없습니다</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>